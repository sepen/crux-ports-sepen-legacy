# Description: VirtualBox is a general-purpose full virtualizer for x86 hardware.
# URL: http://www.virtualbox.org/
# Maintainer: Jose V Beneyto, joberui at ei dot upv dot es
# Packager: Jose V Beneyto, joberui at ei dot upv dot es
# Depends on: bin86,dev86,libxslt,xorg-libxcursor,libsdl,libidl,qt3,xalan-c,iasl

name=virtualbox
version=1.3.8
release=1
source=(http://www.virtualbox.org/download/${version}/VirtualBox-OSE-${version}.tar.bz2 \
        ${name} vboxd 60-vboxdrv.rules)

build() {
  cd vbox-ose-${version}
  ./configure --with-qt-dir=/usr/share/qt
  source ./env.sh
  kmk all
  # compile kernel module
  cd out/linux.x86/release/bin/src
  make
  # install kernel module
  install -D -m 0644 vboxdrv.ko ${PKG}/lib/modules/`uname -r`/kernel/drivers/misc/vboxdrv.ko
  # remove garbage
  rm -rf ${SRC}/vbox-ose-${version}/out/linux.x86/release/bin/{src,sdk/samples,vboxdrv.ko}
  rm -rf ${SRC}/vbox-ose-${version}/out/linux.x86/release/bin/{testcase,additions/src}
  find ${SRC}/vbox-ose-${version}/out/linux.x86/release/bin -type f -name 'tst*' -exec rm -rf {} \;
  # install the rest 
  install -D -m 0644 ${SRC}/60-vboxdrv.rules ${PKG}/etc/udev/rules.d/60-vboxdrv.rules
  install -D -m 0755 ${SRC}/vboxd ${PKG}/etc/rc.d/vboxd
  install -d ${PKG}/usr/{bin,share/${name}}
  install -m 0755 ${SRC}/${name} ${PKG}/usr/bin/${name}
  mv ${SRC}/vbox-ose-${version}/out/linux.x86/release/{bin,lib} ${PKG}/usr/share/${name}
}
