# Description: VirtualBox is a general-purpose full virtualizer for x86 hardware.
# URL: http://www.virtualbox.org/
# Maintainer: Jose V Beneyto, sepen at users dot sourceforge dot net
# Packager: Jose V Beneyto, sepen at users dot sourceforge dot net
# Depends on: bin86,dev86,xorg-libxcursor,hal,libsdl,libidl,qt3,xalan-c,iasl

name=virtualbox
version=1.5.6
release=1
source=(http://www.virtualbox.org/download/${version}/VirtualBox-${version}-1_OSE.tar.bz2 \
        ${name} 60-vboxdrv.rules ${name}.desktop)

build() {
  cd VirtualBox-${version}_OSE
  # compile
  ./configure --with-qt-dir=/usr/share/qt \
              --disable-pulse
  source ./env.sh
  kmk all
  # compile kernel module
  cd out/linux.x86/release/bin/src
  make
  # install kernel module
  install -D -m 0644 vboxdrv.ko ${PKG}/lib/modules/`uname -r`/kernel/drivers/misc/vboxdrv.ko
  # remove superfluous files
  rm -rf ${SRC}/VirtualBox-${version}_OSE/out/linux.x86/release/bin/{src,sdk/samples,testcase} \
    ${SRC}/VirtualBox-${version}_OSE/out/linux.x86/release/bin/{vboxdrv.ko,additions/src,nls}
  find ${SRC}/VirtualBox-${version}_OSE/out/linux.x86/release/bin -type f -name 'tst*' -exec rm -rf {} \;
  # do the rest
  install -D -m 0644 ${SRC}/60-vboxdrv.rules ${PKG}/etc/udev/rules.d/60-vboxdrv.rules
  install -d ${PKG}/usr/{bin,share/${name},share/pixmaps}
  install -m 0755 ${SRC}/${name} ${PKG}/usr/bin/${name}
  mv ${SRC}/VirtualBox-${version}_OSE/out/linux.x86/release/{bin,lib} ${PKG}/usr/share/${name}
  install -D -m 0644 ${SRC}/${name}.desktop ${PKG}/usr/share/applications/${name}.desktop
  mv ${PKG}/usr/share/${name}/bin/VBox.png ${PKG}/usr/share/pixmaps/${name}.png
  rm ${PKG}/usr/share/${name}/bin/{VBox.sh,SUP*nstall}
}
